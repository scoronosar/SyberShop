generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         String   @default("user")
  createdAt    DateTime @default(now())
  contactInfo  Json?

  carts     Cart[]
  orders    Order[]
  favorites Favorite[]
}

model Product {
  id         String   @id @default(uuid())
  externalId String   @unique
  titleOrig  String
  titleEn    String?
  priceCny   Decimal  @db.Decimal(14, 2)
  images     String[]
  skus       Json?
  rating     Float?
  sales      Int?
  rawJson    Json?
  cachedAt   DateTime @default(now())

  priceSnapshots ProductPriceSnapshot[]
  orderItems     OrderItem[]
  cartItems      CartItem[]
}

model ProductPriceSnapshot {
  id             String   @id @default(uuid())
  product        Product  @relation(fields: [productId], references: [id])
  productId      String
  rateUsed       Decimal  @db.Decimal(14, 4)
  convertedPrice Decimal  @db.Decimal(14, 2)
  finalPrice     Decimal  @db.Decimal(14, 2)
  serviceFee     Decimal  @db.Decimal(14, 4)
  calculatedAt   DateTime @default(now())

  cartItems  CartItem[]
  orderItems OrderItem[]
}

model Cart {
  id        String     @id @default(uuid())
  user      User       @relation(fields: [userId], references: [id])
  userId    String
  createdAt DateTime   @default(now())
  items     CartItem[]
}

model CartItem {
  id         String   @id @default(uuid())
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId     String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  sku        String?
  qty        Int
  snapshotId String?
  snapshot   ProductPriceSnapshot? @relation(fields: [snapshotId], references: [id])

  @@unique([cartId, productId, sku])
}

model Order {
  id          String      @id @default(uuid())
  user        User        @relation(fields: [userId], references: [id])
  userId      String
  subtotal    Decimal     @db.Decimal(14, 2)
  deliveryFee Decimal     @db.Decimal(14, 2) @default(0)
  total       Decimal     @db.Decimal(14, 2)
  status      String      @default("pending_processing")
  createdAt   DateTime    @default(now())
  chinaOrder  ChinaOrder? @relation(fields: [chinaOrderId], references: [id])
  chinaOrderId String?
  items       OrderItem[]
}

model OrderItem {
  id         String     @id @default(uuid())
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId    String
  product    Product    @relation(fields: [productId], references: [id])
  productId  String
  sku        String?
  qty        Int
  finalPrice Decimal    @db.Decimal(14, 2)
  snapshot   ProductPriceSnapshot? @relation(fields: [snapshotId], references: [id])
  snapshotId String?
}

model ChinaOrder {
  id       String   @id @default(uuid())
  status   String   @default("created")
  orders   Order[]
  items    Json?
  totalYuan Decimal? @db.Decimal(14, 2)
  warehouse String?
  cargos    Cargo[]
}

model Cargo {
  id           String   @id @default(uuid())
  chinaOrder   ChinaOrder @relation(fields: [chinaOrderId], references: [id])
  chinaOrderId String
  trackers     Tracker[]
  weight       Decimal? @db.Decimal(14, 3)
  volume       Decimal? @db.Decimal(14, 3)
  arrivalDate  DateTime?
  shippingCost Decimal? @db.Decimal(14, 2)
  status       String   @default("created")
}

model Tracker {
  id             String  @id @default(uuid())
  imei           String  @unique
  type           String?
  status         String?
  assignedCargo  Cargo?  @relation(fields: [assignedCargoId], references: [id])
  assignedCargoId String?
}

model TaoworldToken {
  id                String   @id @default(uuid())
  accessToken       String   @unique
  refreshToken      String?
  expiresAt         DateTime
  refreshExpiresAt  DateTime?
  accountId         String?
  sellerId          String?
  userId            String?
  accountPlatform   String?
  shortCode         String?
  account           String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model CurrencyRate {
  id          String   @id @default(uuid())
  currency    String   @unique // RUB, USD, UZS, TJS, KZT, CNY
  code        String   // Currency code
  name        String   // Currency name
  symbol      String   // Currency symbol
  rateFromCNY Decimal  @db.Decimal(14, 4) // Exchange rate from CNY
  markup      Decimal  @db.Decimal(5, 2) @default(1.05) // Markup coefficient
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model Favorite {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  productId   String   // External Taobao ID
  productData Json?    // Cached product data
  createdAt   DateTime @default(now())

  @@unique([userId, productId])
}

model ProductCategory {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameEn      String?
  icon        String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

